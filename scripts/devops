#!/usr/bin/env bash
#
# DevOps CLI - Main entry point for DevOps plugin commands
# Usage: devops <command> [options]
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VERSION="1.0.0"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Print colored output
info() { echo -e "${BLUE}ℹ${NC} $*"; }
success() { echo -e "${GREEN}✓${NC} $*"; }
warn() { echo -e "${YELLOW}⚠${NC} $*"; }
error() { echo -e "${RED}✗${NC} $*" >&2; }

# Show usage
usage() {
    cat <<EOF
DevOps CLI v${VERSION}

Usage: devops <command> [options]

Commands:
  deploy              Deploy application to various platforms
  security-scan       Run security scans on codebase
  infrastructure-audit Audit infrastructure for security and best practices
  cache-manage        Manage application caches (Redis, CDN)
  logs                View and analyze logs from various sources
  secrets-manage      Manage secrets across secret managers
  k8s-deploy          Deploy to Kubernetes
  db-migrate          Run database migrations
  create-pipeline     Generate CI/CD pipeline configuration

Options:
  -h, --help          Show this help message
  -v, --version       Show version
  --dry-run           Show what would be done without executing

Examples:
  devops deploy production
  devops security-scan --severity=high
  devops infrastructure-audit --format=json
  devops cache-manage flush "user:*"
  devops logs k8s/myapp --since=1h

For command-specific help:
  devops <command> --help

EOF
}

# Check if command script exists
command_exists() {
    [[ -f "${SCRIPT_DIR}/devops-$1" ]] || [[ -f "${SCRIPT_DIR}/$1.sh" ]]
}

# Run command
run_command() {
    local cmd="$1"
    shift

    if [[ -f "${SCRIPT_DIR}/devops-${cmd}" ]]; then
        exec "${SCRIPT_DIR}/devops-${cmd}" "$@"
    elif [[ -f "${SCRIPT_DIR}/${cmd}.sh" ]]; then
        exec "${SCRIPT_DIR}/${cmd}.sh" "$@"
    else
        error "Unknown command: $cmd"
        echo ""
        usage
        exit 1
    fi
}

# Main
main() {
    if [[ $# -eq 0 ]]; then
        usage
        exit 0
    fi

    case "$1" in
        -h|--help)
            usage
            exit 0
            ;;
        -v|--version)
            echo "DevOps CLI v${VERSION}"
            exit 0
            ;;
        deploy|security-scan|infrastructure-audit|cache-manage|logs|secrets-manage|k8s-deploy|db-migrate|create-pipeline)
            run_command "$@"
            ;;
        *)
            error "Unknown command: $1"
            echo ""
            usage
            exit 1
            ;;
    esac
}

main "$@"
