#!/usr/bin/env bash
#
# Security Scan - Comprehensive security scanning for code and infrastructure
# Usage: devops security-scan [scope] [options]
#

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Default settings
SCAN_DIR="${SCAN_DIR:-.}"
OUTPUT_FORMAT="${OUTPUT_FORMAT:-text}"
SEVERITY="${SEVERITY:-HIGH,CRITICAL}"
DRY_RUN=false
FAIL_ON_FINDINGS=false

# Counters
CRITICAL=0
HIGH=0
MEDIUM=0
LOW=0

info() { echo -e "${BLUE}ℹ${NC} $*"; }
success() { echo -e "${GREEN}✓${NC} $*"; }
warn() { echo -e "${YELLOW}⚠${NC} $*"; }
error() { echo -e "${RED}✗${NC} $*" >&2; }
header() { echo -e "\n${BOLD}${CYAN}$*${NC}"; }

usage() {
    cat <<EOF
Security Scan - Comprehensive security scanning

Usage: devops security-scan [scope] [options]

Scopes:
  all                 Run all available scans (default)
  code                Static code analysis (Semgrep, Bandit)
  secrets             Secret detection (Gitleaks, TruffleHog)
  dependencies        Dependency vulnerabilities (Trivy, npm audit)
  container           Container image scanning (Trivy)
  iac                 Infrastructure as Code (Checkov, tfsec)

Options:
  --dir=PATH          Directory to scan (default: current)
  --severity=LEVELS   Minimum severity: LOW, MEDIUM, HIGH, CRITICAL (default: HIGH,CRITICAL)
  --format=FORMAT     Output format: text, json, sarif (default: text)
  --output=FILE       Save results to file
  --fail              Exit with error if findings detected
  --fix               Attempt to auto-fix issues where possible
  --baseline=FILE     Compare against baseline file
  --exclude=PATTERN   Exclude paths matching pattern
  --dry-run           Show what scans would run
  -h, --help          Show this help

Examples:
  devops security-scan
  devops security-scan code --severity=MEDIUM
  devops security-scan secrets --fail
  devops security-scan container --image=myapp:latest
  devops security-scan dependencies --format=json --output=results.json
  devops security-scan iac --dir=terraform/

Supported Tools:
  Code:         semgrep, bandit (Python), eslint-security
  Secrets:      gitleaks, trufflehog
  Dependencies: trivy, npm audit, pip-audit, cargo-audit
  Containers:   trivy, grype
  IaC:          checkov, tfsec, kics

Environment Variables:
  SCAN_DIR            Default scan directory
  OUTPUT_FORMAT       Default output format
  SEVERITY            Default severity filter

EOF
}

# Check which tools are available
check_tools() {
    header "Checking Available Tools"

    local tools=(
        "semgrep:Code analysis"
        "bandit:Python security"
        "gitleaks:Secret detection"
        "trufflehog:Secret detection"
        "trivy:Vulnerability scanning"
        "grype:Container scanning"
        "checkov:IaC security"
        "tfsec:Terraform security"
        "npm:Node.js audit"
        "pip-audit:Python audit"
    )

    for entry in "${tools[@]}"; do
        local tool="${entry%%:*}"
        local desc="${entry##*:}"
        if command -v "$tool" &>/dev/null; then
            success "$tool: $desc"
        else
            warn "$tool: not installed ($desc)"
        fi
    done
}

# Secret scanning
scan_secrets() {
    header "Secret Detection"

    local found=0

    # Gitleaks
    if command -v gitleaks &>/dev/null; then
        info "Running Gitleaks..."
        if [[ "$DRY_RUN" == "true" ]]; then
            info "[DRY RUN] Would run: gitleaks detect --source $SCAN_DIR"
        else
            local gitleaks_output
            gitleaks_output=$(gitleaks detect --source "$SCAN_DIR" --no-git 2>&1) || {
                error "Secrets detected by Gitleaks!"
                echo "$gitleaks_output"
                ((CRITICAL++))
                found=1
            }
            [[ $found -eq 0 ]] && success "Gitleaks: No secrets found"
        fi
    fi

    # TruffleHog
    if command -v trufflehog &>/dev/null; then
        info "Running TruffleHog..."
        if [[ "$DRY_RUN" == "true" ]]; then
            info "[DRY RUN] Would run: trufflehog filesystem $SCAN_DIR"
        else
            if trufflehog filesystem "$SCAN_DIR" --no-update 2>/dev/null | grep -q "Found"; then
                error "Secrets detected by TruffleHog!"
                ((CRITICAL++))
                found=1
            else
                success "TruffleHog: No secrets found"
            fi
        fi
    fi

    # Manual patterns check
    info "Checking common secret patterns..."
    local patterns=(
        'password\s*=\s*["\x27][^"\x27]{8,}'
        'api[_-]?key\s*=\s*["\x27][^"\x27]{20,}'
        'secret\s*=\s*["\x27][^"\x27]{10,}'
        'BEGIN\s+(RSA|DSA|EC|OPENSSH)\s+PRIVATE\s+KEY'
        'ghp_[a-zA-Z0-9]{36}'
        'sk-[a-zA-Z0-9]{48}'
        'AKIA[0-9A-Z]{16}'
    )

    for pattern in "${patterns[@]}"; do
        local matches
        matches=$(grep -rEn "$pattern" "$SCAN_DIR" \
            --include="*.py" --include="*.js" --include="*.ts" \
            --include="*.yaml" --include="*.yml" --include="*.json" \
            --include="*.env*" --include="*.config" \
            2>/dev/null | grep -v "node_modules" | grep -v ".git" | head -5 || true)
        if [[ -n "$matches" ]]; then
            warn "Potential secrets matching pattern:"
            echo "$matches"
            ((HIGH++))
        fi
    done

    return $found
}

# Code scanning
scan_code() {
    header "Static Code Analysis"

    # Semgrep
    if command -v semgrep &>/dev/null; then
        info "Running Semgrep..."
        if [[ "$DRY_RUN" == "true" ]]; then
            info "[DRY RUN] Would run: semgrep scan $SCAN_DIR"
        else
            semgrep scan "$SCAN_DIR" \
                --config=auto \
                --severity=WARNING \
                --no-git-ignore \
                --quiet 2>/dev/null || {
                warn "Semgrep found issues"
                ((HIGH++))
            }
        fi
    fi

    # Bandit for Python
    if command -v bandit &>/dev/null && find "$SCAN_DIR" -name "*.py" -type f | head -1 | grep -q .; then
        info "Running Bandit (Python)..."
        if [[ "$DRY_RUN" == "true" ]]; then
            info "[DRY RUN] Would run: bandit -r $SCAN_DIR"
        else
            bandit -r "$SCAN_DIR" -ll -q 2>/dev/null || {
                warn "Bandit found security issues"
                ((HIGH++))
            }
        fi
    fi

    # Check for dangerous patterns
    info "Checking dangerous code patterns..."

    # SQL injection
    local sql_issues
    sql_issues=$(grep -rEn 'execute\s*\(\s*["\x27].*%|execute\s*\(.*\.format\(' "$SCAN_DIR" \
        --include="*.py" 2>/dev/null | grep -v "node_modules" | head -5 || true)
    if [[ -n "$sql_issues" ]]; then
        warn "Potential SQL injection:"
        echo "$sql_issues"
        ((HIGH++))
    fi

    # Command injection
    local cmd_issues
    cmd_issues=$(grep -rEn 'os\.system\s*\(|subprocess\.call\s*\([^,]*shell\s*=\s*True|eval\s*\(' "$SCAN_DIR" \
        --include="*.py" 2>/dev/null | grep -v "node_modules" | head -5 || true)
    if [[ -n "$cmd_issues" ]]; then
        warn "Potential command injection:"
        echo "$cmd_issues"
        ((HIGH++))
    fi

    # XSS in JavaScript
    local xss_issues
    xss_issues=$(grep -rEn 'innerHTML\s*=|document\.write\s*\(|v-html=' "$SCAN_DIR" \
        --include="*.js" --include="*.ts" --include="*.vue" --include="*.jsx" \
        2>/dev/null | grep -v "node_modules" | head -5 || true)
    if [[ -n "$xss_issues" ]]; then
        warn "Potential XSS vulnerabilities:"
        echo "$xss_issues"
        ((MEDIUM++))
    fi
}

# Dependency scanning
scan_dependencies() {
    header "Dependency Vulnerability Scan"

    # Trivy for filesystem
    if command -v trivy &>/dev/null; then
        info "Running Trivy..."
        if [[ "$DRY_RUN" == "true" ]]; then
            info "[DRY RUN] Would run: trivy fs $SCAN_DIR"
        else
            trivy fs "$SCAN_DIR" \
                --severity "$SEVERITY" \
                --quiet 2>/dev/null || {
                warn "Trivy found vulnerabilities"
                ((HIGH++))
            }
        fi
    fi

    # npm audit
    if [[ -f "$SCAN_DIR/package-lock.json" ]]; then
        info "Running npm audit..."
        if [[ "$DRY_RUN" == "true" ]]; then
            info "[DRY RUN] Would run: npm audit"
        else
            (cd "$SCAN_DIR" && npm audit --audit-level=high 2>/dev/null) || {
                warn "npm audit found vulnerabilities"
                ((HIGH++))
            }
        fi
    fi

    # pip-audit
    if command -v pip-audit &>/dev/null && [[ -f "$SCAN_DIR/requirements.txt" ]]; then
        info "Running pip-audit..."
        if [[ "$DRY_RUN" == "true" ]]; then
            info "[DRY RUN] Would run: pip-audit -r requirements.txt"
        else
            pip-audit -r "$SCAN_DIR/requirements.txt" 2>/dev/null || {
                warn "pip-audit found vulnerabilities"
                ((HIGH++))
            }
        fi
    fi

    # cargo-audit
    if command -v cargo-audit &>/dev/null && [[ -f "$SCAN_DIR/Cargo.lock" ]]; then
        info "Running cargo-audit..."
        if [[ "$DRY_RUN" == "true" ]]; then
            info "[DRY RUN] Would run: cargo audit"
        else
            (cd "$SCAN_DIR" && cargo audit 2>/dev/null) || {
                warn "cargo-audit found vulnerabilities"
                ((HIGH++))
            }
        fi
    fi
}

# Container scanning
scan_container() {
    local image="${1:-}"

    header "Container Security Scan"

    if [[ -z "$image" ]]; then
        # Look for Dockerfile and scan built images
        if [[ -f "$SCAN_DIR/Dockerfile" ]]; then
            info "Found Dockerfile, scanning for issues..."

            # Hadolint
            if command -v hadolint &>/dev/null; then
                hadolint "$SCAN_DIR/Dockerfile" 2>/dev/null || {
                    warn "Dockerfile issues found"
                    ((MEDIUM++))
                }
            fi
        else
            warn "No image specified and no Dockerfile found"
            return 0
        fi
    else
        # Trivy image scan
        if command -v trivy &>/dev/null; then
            info "Scanning image: $image"
            if [[ "$DRY_RUN" == "true" ]]; then
                info "[DRY RUN] Would run: trivy image $image"
            else
                trivy image "$image" \
                    --severity "$SEVERITY" \
                    --quiet 2>/dev/null || {
                    warn "Vulnerabilities found in image"
                    ((HIGH++))
                }
            fi
        fi

        # Grype
        if command -v grype &>/dev/null; then
            info "Running Grype on: $image"
            if [[ "$DRY_RUN" == "true" ]]; then
                info "[DRY RUN] Would run: grype $image"
            else
                grype "$image" --fail-on high 2>/dev/null || {
                    warn "Grype found vulnerabilities"
                    ((HIGH++))
                }
            fi
        fi
    fi
}

# Infrastructure as Code scanning
scan_iac() {
    header "Infrastructure as Code Security"

    # Checkov
    if command -v checkov &>/dev/null; then
        info "Running Checkov..."
        if [[ "$DRY_RUN" == "true" ]]; then
            info "[DRY RUN] Would run: checkov -d $SCAN_DIR"
        else
            checkov -d "$SCAN_DIR" \
                --quiet \
                --compact 2>/dev/null || {
                warn "Checkov found issues"
                ((HIGH++))
            }
        fi
    fi

    # tfsec for Terraform
    if command -v tfsec &>/dev/null && find "$SCAN_DIR" -name "*.tf" -type f | head -1 | grep -q .; then
        info "Running tfsec..."
        if [[ "$DRY_RUN" == "true" ]]; then
            info "[DRY RUN] Would run: tfsec $SCAN_DIR"
        else
            tfsec "$SCAN_DIR" \
                --minimum-severity HIGH 2>/dev/null || {
                warn "tfsec found issues"
                ((HIGH++))
            }
        fi
    fi

    # Manual Kubernetes checks
    if find "$SCAN_DIR" -name "*.yaml" -type f | xargs grep -l "kind:" 2>/dev/null | head -1 | grep -q .; then
        info "Checking Kubernetes manifests..."

        # Privileged containers
        local privileged
        privileged=$(grep -rn "privileged: true" "$SCAN_DIR" --include="*.yaml" --include="*.yml" 2>/dev/null || true)
        if [[ -n "$privileged" ]]; then
            error "CRITICAL: Privileged containers found"
            echo "$privileged"
            ((CRITICAL++))
        fi

        # Root user
        local root_user
        root_user=$(grep -rn "runAsUser: 0" "$SCAN_DIR" --include="*.yaml" --include="*.yml" 2>/dev/null || true)
        if [[ -n "$root_user" ]]; then
            warn "HIGH: Containers running as root"
            echo "$root_user"
            ((HIGH++))
        fi
    fi
}

# Print summary
print_summary() {
    header "Security Scan Summary"

    echo ""
    [[ $CRITICAL -gt 0 ]] && error "CRITICAL: $CRITICAL"
    [[ $HIGH -gt 0 ]] && warn "HIGH: $HIGH"
    [[ $MEDIUM -gt 0 ]] && info "MEDIUM: $MEDIUM"
    [[ $LOW -gt 0 ]] && info "LOW: $LOW"

    local total=$((CRITICAL + HIGH + MEDIUM + LOW))

    echo ""
    if [[ $total -eq 0 ]]; then
        success "No security issues found!"
        return 0
    else
        error "Total findings: $total"
        if [[ "$FAIL_ON_FINDINGS" == "true" ]] && [[ $CRITICAL -gt 0 || $HIGH -gt 0 ]]; then
            return 1
        fi
    fi
}

# Main
main() {
    local scope="all"
    local image=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            all|code|secrets|dependencies|container|iac)
                scope="$1"; shift ;;
            --dir=*) SCAN_DIR="${1#*=}"; shift ;;
            --severity=*) SEVERITY="${1#*=}"; shift ;;
            --format=*) OUTPUT_FORMAT="${1#*=}"; shift ;;
            --image=*) image="${1#*=}"; shift ;;
            --fail) FAIL_ON_FINDINGS=true; shift ;;
            --dry-run) DRY_RUN=true; shift ;;
            -h|--help) usage; exit 0 ;;
            *) shift ;;
        esac
    done

    header "Security Scan"
    info "Directory: $SCAN_DIR"
    info "Scope: $scope"
    info "Severity: $SEVERITY"

    check_tools

    case "$scope" in
        all)
            scan_secrets
            scan_code
            scan_dependencies
            scan_container "$image"
            scan_iac
            ;;
        secrets) scan_secrets ;;
        code) scan_code ;;
        dependencies) scan_dependencies ;;
        container) scan_container "$image" ;;
        iac) scan_iac ;;
    esac

    print_summary
}

main "$@"
